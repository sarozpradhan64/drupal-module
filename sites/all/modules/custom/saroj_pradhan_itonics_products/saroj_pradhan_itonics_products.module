<?php


function saroj_pradhan_itonics_products_menu()
{
  $items = array();

  // index 
  $items['admin/content/itonics-products'] = array(
    'title' => 'ITONICS Products',
    'description' => 'Manage ITONICS products',
    'page callback' => 'saroj_pradhan_itonics_products_list',
    'access arguments' => array('administer itonics products'),
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'management',
  );

  $items['admin/content/itonics-products/add'] = array(
    'title' => 'Add Product',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('saroj_pradhan_itonics_products_form'),
    'access arguments' => array('administer itonics products'),
    'type' => MENU_LOCAL_ACTION,
  );

  $items['admin/content/itonics-products/%/edit'] = array(
    'title' => 'Edit Product',
    'page callback' => 'drupal_get_form',
    // The 3 --> third argument from the URL.
    'page arguments' => array('saroj_pradhan_itonics_products_form', 3),
    'access arguments' => array('administer itonics products'),
    'type' => MENU_CALLBACK,
  );

  $items['admin/content/itonics-products/%/delete'] = array(
    'title' => 'Delete Product',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('saroj_pradhan_itonics_products_delete_form', 3),
    'access arguments' => array('administer itonics products'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}



/**
 * Impplements hook_init()
 */

function saroj_pradhan_itonics_products_init()
{
  if (module_exists('libraries')) {
    // Loading Tinymce 
    libraries_load('tinymce');
  }

  // jquery date picker 
  drupal_add_library('system', 'ui.datepicker');


  // if (path_is_admin('admin/content/itonics-products/*')) {
  //   drupal_add_js(drupal_get_path('module', 'saroj_pradhan_itonics_products') . '/js/script.js');
  // }
}


/**
 * Page callback: Product listing page.
 */
function saroj_pradhan_itonics_products_list()
{
  $header = array(
    array('data' => t('ID'), 'field' => 'id'),
    array('data' => t('Image'), 'field' => 'image_id'),
    array('data' => t('Title'), 'field' => 'title'),
    array('data' => t('Type'), 'field' => 'type'),
    array('data' => t('Owner Email'), 'field' => 'owner_email'),
    array('data' => t('Expiry Date'), 'field' => 'expiry_date'),
    array('data' => t('Operations'), 'colspan' => 2),
  );

  // Create a sortable table query
  $query = db_select('saroj_pradhan_itonics_products', 'p')
    ->extend('PagerDefault')
    ->extend('TableSort');

  $query->fields('p', array('id', 'image_id', 'title', 'type', 'owner_email', 'expiry_date'));

  $result = $query
    ->limit(20)
    ->orderByHeader($header)
    ->execute();

  $rows = array();
  foreach ($result as $product) {

    $image = '';
    if ($product->image_id) {
      $file = file_load($product->image_id);
      if ($file) {
        $image = theme('image_style', array(
          'style_name' => 'thumbnail',
          'path' => $file->uri,
          'width' => 50,
          'height' => 50,
          'alt' => $product->title,
        ));
      }
    }

    $rows[] = array(
      $product->id,
      $image,
      $product->title,
      $product->type,
      $product->owner_email,
      date('Y-m-d', $product->expiry_date),
      l(t('Edit'), "admin/content/itonics-products/$product->id/edit"),
      l(t('Delete'), "admin/content/itonics-products/$product->id/delete"),
    );
  }

  $build['product_table'] = array(
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#empty' => t('No products available.'),
  );

  $build['product_pager'] = array('#theme' => 'pager');

  return $build;
}


function saroj_pradhan_itonics_products_form($form, &$form_state, $product_id = NULL)
{
  $form = array();

  if ($product_id) {
    // print_r('test');
    $product = db_query(
      "SELECT * FROM saroj_pradhan_itonics_products WHERE id = :id",
      array(':id' => $product_id)
    )->fetchObject();
    if ($product) {
      $form['id'] = array(
        '#type' => 'value',
        '#value' => $product_id,
      );
    }
  }


  $form['title'] = array(
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#required' => TRUE,
    '#default_value' => isset($product) ? $product->title : '',
  );


  $form['image'] = array(
    '#type' => 'file',
    '#title' => t('Image'),
    '#upload_location' => 'public://product_images/',
    '#description' => t('Choose Product Image.'),
  );

  if (isset($product) && $product->image_id) {
    $file = file_load($product->image_id);
    if ($file) {
      $form['current_image'] = array(
        '#markup' => theme('image_style', array(
          'style_name' => 'thumbnail',
          'path' => $file->uri,
        )),
      );
    }
  }


  $form['summary'] = array(
    '#type' => 'textarea',
    '#title' => t('Summary'),
    '#default_value' => isset($product) ? $product->summary : '',
  );


  $form['description'] = array(
    '#type' => 'text_format',
    '#title' => t('Description'),
    '#default_value' => isset($product) ? $product->description : '',
    '#format' => 'full_html',
  );


  $category_options = array(
    'laptop' => t('Laptop'),
    'mobile' => t('Mobile'),
    'books' => t('Books'),
    'toys' => t('Toys'),
    'clothings' => t('Clothings'),
  );

  $form['category'] = array(
    '#type' => 'select',
    '#title' => t('Category'),
    '#options' => $category_options,
    '#multiple' => TRUE,
    '#required' => TRUE,
    '#default_value' => isset($product) ? unserialize($product->category) : array(),
    '#attributes' => array('class' => array('multiselect')),
  );


  $type_options = array(
    'new' => t('New'),
    'trending' => t('Trending'),
    'popular' => t('Popular'),
  );

  $form['type'] = array(
    '#type' => 'radios',
    '#title' => t('Type'),
    '#options' => $type_options,
    '#required' => TRUE,
    '#default_value' => isset($product) ? $product->type : '',
  );

  $form['owner_email'] = array(
    '#type' => 'textfield',
    '#title' => t('Owner Email'),
    '#required' => TRUE,
    '#default_value' => isset($product) ? $product->owner_email : '',
  );

  $form['expiry_date'] = array(
    '#type' => 'date',
    '#title' => t('Expiry Date'),
    '#required' => TRUE,
    '#default_value' => isset($product, $product->expiry_date) ? array(
      'day' => date('d', $product->expiry_date),
      'month' => date('m', $product->expiry_date),
      'year' => date('Y', $product->expiry_date)
    ) : '',
    '#attributes' => array('class' => array('datepicker')),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => isset($product) ? t('Update Product') : t('Save Product'),
  );

  // js path 
  $form['#attached']['js'][] = array(
    'data' => drupal_get_path('module', 'saroj_pradhan_itonics_products') . '/js/form.js',
    'type' => 'file',
  );

  return $form;
}

/** 
 * Product form validation
 */
function saroj_pradhan_itonics_products_form_validate($form, &$form_state)
{
  // owner email validation 
  if (!valid_email_address($form_state['values']['owner_email'])) {
    form_set_error('owner_email', t('Invalid Owner Email'));
  }

  // Image  validation
  // $file = file_save_upload('image', array(
  //   'file_validate_is_image' => array(),
  //   'file_validate_extensions' => array('png gif jpg jpeg'),
  // ));

  // if ($file) {
  //   $form_state['values']['image'] = $file;
  // }

  // Expiry date validation
  // $expiry_date = $form_state['values']['expiry_date'];

  // if (!strtotime($expiry_date)) {
  //   form_set_error('expiry_date', t('Invalid Expiry Date'));
  // }
}


/**
 * Handle product form submission
 */

function saroj_pradhan_itonics_products_form_submit($form, &$form_state)
{
  $values = $form_state['values'];
  $product_id = $values['id'] ?? null;
  $product = new stdClass();
  $product->title = $values['title'];
  $product->summary = $values['summary'];
  $product->description = $values['description']['value'];
  $product->category = serialize($values['category']);
  $product->type = $values['type'];
  $product->owner_email = $values['owner_email'];

  // strtotime('Y-m-d')
  // $product->expiry_date = strtotime($values['expiry_date']);
  $product->expiry_date = strtotime($values['expiry_date']['year'] . "-" . $values['expiry_date']['month'] . "-" . $values['expiry_date']['day']);

  // Handle image upload
  // if ($values['image']) {
  // $file = $values['image']; // Load the file entity

  // // if ($file) {
  // // $file = file_save_upload($file->uri, $validators, 'public://product_image/' .  $file->filename, FILE_EXISTS_REPLACE);
  // $file->status = FILE_STATUS_PERMANENT;
  // $file_saved = file_save($file);

  // // variable_set('image_id', $file_saved->fid);
  // $product->image_id = $file_saved->fid;
  // // }
  // // }

  if ($product_id) {
    // update product 
    $product->id = $product_id;
    drupal_write_record('saroj_pradhan_itonics_products', $product, 'id');
    drupal_set_message(t('Product updated successfully'));
  } else {
    // craete product
    drupal_write_record('saroj_pradhan_itonics_products', $product);
    drupal_set_message(t('Product added successfully'));
  }

  $form_state['redirect'] = '/admin/content/itonics-products';
}


/**
 * Product Delete Dialog.
 */
function saroj_pradhan_itonics_products_delete_form($form, &$form_state, $product_id)
{
  $form['id'] = array(
    '#type' => 'value',
    '#value' => $product_id,
  );

  return confirm_form(
    $form,
    t('This will permanently remove the product !'),
    'admin/content/itonics-products',
    t('Are you sure you want to delete this product.'),
    t('Yes, Delete'),
    t('Cancel')
  );
}

/**
 * Handle Product Delete.
 */
function saroj_pradhan_itonics_products_delete_form_submit($form, &$form_state)
{
  if ($form_state['values']['id']) {
    $product = db_select('saroj_pradhan_itonics_products', 'p')
      ->fields('p')
      ->condition('id', $form_state['values']['id'])
      ->execute()
      ->fetchObject();

    if ($product) {
      // Delete associated image
      if ($product->image_id) {
        $file = file_load($product->image_id);
        if ($file) {
          file_usage_delete($file, 'saroj_pradhan_itonics_products');
          file_delete($file);
        }
      }

      // Delete product
      db_delete('saroj_pradhan_itonics_products')
        ->condition('id', $product->id)
        ->execute();

      drupal_set_message(t('Product has been deleted.'));
    }
  }

  $form_state['redirect'] = 'admin/content/itonics-products';
}
